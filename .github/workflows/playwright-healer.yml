name: Playwright Healer Agent - Auto Fix

on:
  issues:
    types: [opened, edited, reopened]

jobs:
  heal:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # Allow auto-commit of fixes
      issues: read      # Allow reading issue context
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      # ðŸ‘‡ Optional: print the issue data
      - name: Fetch issue content
        id: issue
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/${{ github.repository }}/issues/${{ github.event.issue.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Show issue data
        run: |
          echo "Title: ${{ fromJson(steps.issue.outputs.data).title }}"
          echo "Body: ${{ fromJson(steps.issue.outputs.data).body }}"

      # ðŸ‘‡ Run Playwright's Healer Agent to attempt a fix
      - name: Initialize agents
        run: npx playwright init-agents --loop opencode

      - name: Auto-heal using Playwright Agent
        run: npx playwright heal --auto-fix --commit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push possible fixes
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git push origin HEAD:${{ github.ref_name }}
